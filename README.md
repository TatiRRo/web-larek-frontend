# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка продукта

```
export interface IProduct {
	id: string;
	category: string;
	title: string;
	image: string;
	description: string;
	price: number | string;
}
```

Данные заказа

```
export interface IOrder {
	payment: PaymentMethod;
	address: string;
	email: string;
	phone: string;
    total: number;
    items:IProductInBasket[];
}
```

Интерфейс для модели данных карточек

```
export interface IProductsData {
	products: IProduct [];
    preview: string | null;
}
```

Данные карточки, используемые в форме при создании новой карточки

```
export type IProductItemList = Pick<IProduct, 'category' | 'title'| 'image'| 'price'>;
```

Данные карточки, используемые в модальном окне Просмотра продукта

```
export type IProductPopup = Pick<IProduct, 'category' | 'title'| 'image'| 'description'| 'price'>;
```

Данные карточки, используемые в модальном окне Корзины

```
export type IProductInBasket = Pick<IProduct, 'title' | 'price'>;
```

Данные заказа, используемые в модальном окне Корзины

```
export type IBasketCustomer = Pick<IOrder, 'items' | 'total'>;
```

Данные заказа, используемые в модальном окне Оформление заказа (этап выбора способа оплаты и ввод адреса)

```
export type IPaymentPage = Pick<IOrder, 'payment' | 'address'>;
```

Данные заказа, используемые в модальном окне Оформление заказа (этап ввода контактных данных пользователя)

```
export type IContactsCustomer = Pick<IOrder, 'email' | 'phone'>;
```

Данные заказа, используемые в модальном окне Подтверждение заказа

```
export type IConfirmationOrder = Pick<IOrder, 'total'>;
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:

- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:

- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:

- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

### Слой данных

#### Класс ProductsData

Класс отвечает за хранение и логику работы с данными карточек\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_products: IProduct[]` - массив объектов карточек
- `_preview: string | null` - id карточки, выбранной для просмотра в модальной окне
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `getCard(cardId: string): IProduct | undefined` - возвращает карточку по ее id.Если карточка не найдена — выбрасывает ошибку или возвращает undefined.
- а так-же сеттеры и геттеры для сохранения и получения данных из полей класса

#### Класс OrderData

Класс отвечает за хранение и логику работы с данными корзины пользователя.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `payment: PaymentMethod` - форма оплаты
- `address: string `- адрес для доставки
- `email: string` - email пользователя
- `phone: string` - телефон пользователя
- `total: number` - общая стоимость всех продуктов в корзине
- `items: IProductInBasket[]` - список всех товаров в корзине
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `getOrderInfo(): IBasket` - возвращает данные корзины
- `setOrderInfo(orderData: IOrder): void` - сохраняет данные пользователя в классе
- `deleteProduct(basketId: string, payload: Function | null): void` - удаляет продукт из массива в корзине.Если передан колбэк, то выполняет его после удаления, если нет, то вызывает событие изменения массива.
- `updateOrder(order: IBasket, payload: Function | null): void` - обновляет данные в массиве продуктов в корзине (после удаления товаров). Если передан колбэк, то выполняет его после обновления, если нет, то вызывает событие изменения массива.
- `checkOrderValidation(
data: Record<keyof IPaymentPage, IContactsCustomer>
): boolean` - проверяет объект с данными заказа на валидность

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных

#### Класс Modal

Реализует модальное окно. Также предоставляет методы open и close для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.
constructor(selector: string, events: IEvents) — Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса EventEmitter для возможности инициации событий.

Поля класса:

- `container: HTMLElement` — DOM-элемент контейнера модального окна (.modal\_\_container), используется для управления анимацией и фокусом.
- `closeButton: HTMLButtonElement` — кнопка закрытия модального окна (.modal\_\_close).
- `modalElement: HTMLElement` — корневой DOM-элемент модального окна (.modal).
- `_onClose: () => void` — колбэк, вызываемый при закрытии модального окна (если задан).
- `_handleEscClose: (e: KeyboardEvent) => void` — обработчик для закрытия модального окна по клавише Escape.
- `_handleOutsideClick: (e: MouseEvent) => void` — обработчик закрытия при клике вне содержимого модального окна.

Методы класса:

- `constructor(modalElement: HTMLElement)` - конструктор принимает корневой DOM-элемент модального окна и инициализирует обработчики.
- `open(onClose?: () => void): void` - открывает модальное окно. Добавляет обработчики событий keydown и click, устанавливает колбэк на закрытие, если он передан.
- `close(): void` - закрывает модальное окно. Удаляет обработчики событий и вызывает колбэк \_onClose, если он задан.
- `setEventListeners(): void` - добавляет обработчики событий на кнопку закрытия, клавишу Escape и клик вне области .modal\_\_container.
- `removeEventListeners(): void` - удаляет все обработчики событий, установленные при открытии.

#### Класс ModalWithProduct

Расширяет класс Modal. Предназначен для реализации модального окна с карточкой продукта в большом размере. При открытии модального окна получает продукт, который нужно показать.

Поля класса:

- `imageElement: HTMLImageElement` — элемент разметки с изображением
- `categoryElement: HTMLElement` - элемент с категорией товара
- `titleElement: HTMLElement` - элемент с названием товара
- `descriptionElement: HTMLElement` - элемент с описанием товара
- `priceElement: HTMLElement` - элемент с ценой товара

Методы:

- `open(data: { category: string,title: string,image: string,description: string,price: number | string;}): void` — расширение родительского метода, принимает данные изображения, которые используются для заполнения атрибутов элементов модального окна
- `close(): void` — расширяет родительский метод, выполняя дополнительную очистку атрибутов модального окна

#### Класс ModalWithBasket

Расширяет класс Modal. Предназначен для реализации модального окна с корзиной пользователя. При открытии модального окна получает данные о продуктах, добавленных в корзину, и отображает их в виде списка. Также отображает итоговую сумму всех товаров и предоставляет возможность удалить товар из корзины.

Поля класса:

- `listElement: HTMLElement` — контейнер для списка товаров в корзине (элемент с классом .basket\_\_list)
- `totalPriceElement: HTMLElement` — элемент для отображения общей стоимости (элемент с классом .basket\_\_price)
- `submitButton: HTMLButtonElement` — кнопка оформления заказа
- `_handleDelete: (id: string) => void` — функция, вызываемая при удалении товара из корзины

Методы:

- `open(data: { items: Product[], total: number }): void` — расширение родительского метода. Принимает объект с товарами и итоговой суммой, рендерит список и обновляет итоговую стоимость
- `setDeleteHandler(callback: (id: string) => void): void` — устанавливает колбэк, вызываемый при удалении элемента из корзины
- `clear(): void` — очищает список товаров и обнуляет сумму
- `close(): void` — расширяет родительский метод, дополнительно вызывая clear() для сброса содержимого корзины

#### Класс ModalWithForm<T>

Расширяет класс Modal.
Универсальный базовый класс для реализации модальных окон с формами, в которых необходимо собрать данные от пользователя.
Использует дженерик <T> — тип данных, возвращаемых из формы при её отправке.

Поля класса:

- `form: HTMLFormElement` — DOM-элемент формы внутри модального окна.
- `submitButton: HTMLButtonElement` — кнопка отправки формы.
- `_handleSubmit: (data: T) => void` — функция, вызываемая при успешной отправке формы.
- `_onInput: () => void` — обработчик событий input, валидирует данные формы и включает/отключает кнопку отправки.
- `_onSubmit: (e: Event) => void` — обработчик события submit, предотвращает стандартную отправку и вызывает переданный колбэк.

Методы класса:

- `open(handleSubmit: (data: T) => void): void` - открывает модальное окно, устанавливает обработчики событий, сохраняет колбэк для отправки.
- `close(): void` - закрывает модальное окно, сбрасывает форму, удаляет обработчики событий.
- `setValid(valid: boolean): void` - включает или выключает кнопку отправки формы.
- `protected \_onInput(): void` - получает данные из формы с помощью getFormData() и валидирует их. Используется для автообновления состояния кнопки.
- `protected \_onSubmit(e: Event): void` - отменяет поведение браузера по умолчанию, вызывает handleSubmit() с данными, если форма валидна.
- `protected abstract getFormData(): T | null` - метод, реализуемый в дочерних классах. Возвращает данные из формы или null, если форма заполнена некорректно.

#### Класс ModalWithPayment

Расширяет ModalWithForm<IPaymentPage>.
Предназначен для модального окна, на котором пользователь выбирает способ оплаты и вводит адрес доставки.

Дополнительные поля:

- `buttons: HTMLButtonElement[]` — кнопки выбора способа оплаты (онлайн / при получении).
- `input: HTMLInputElement` — поле ввода адреса доставки.
- `selectedPayment: PaymentMethod | null` — выбранный способ оплаты.

#### Класс ModalWithContacts

Расширяет ModalWithForm<IContactsCustomer>.

Предназначен для модального окна, на котором пользователь вводит email и номер телефона для оформления заказа.

Дополнительные поля:

- `emailInput: HTMLInputElement` — поле ввода email.
- `phoneInput: HTMLInputElement` — поле ввода телефона.

#### Класс ModalWithOrderComplet

Расширяет класс Modal. Отвечает за отображение модального окна с сообщением об успешном оформлении заказа. Используется для информирования пользователя о списании синапсов и завершении покупки.

Поля класса:

- `submitButton: HTMLButtonElement` – кнопка подтверждения

Методы:

- `setSynapseAmount(amount: number): void` — обновляет текст в описании модального окна с актуальным количеством списанных синапсов.

#### Класс Product

Отвечает за отображение карточки, задавая в карточке данные категории, названия, изображения, описания, цены продукта. Класс используется для отображения карточек на странице сайта. В конструктор класса передается DOM элемент template, что позволяет при необходимости формировать карточки разных вариантов верстки. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователем генерируются соответствующие события.
В полях класса содержатся элементы разметки элемента карточки. Конструктор, кроме template, принимает экземпляр EventEmitter для инициации событий.

Методы:

- `setData(cardData: IProduct , userId: string): voi`d – заполняет атрибуты элементов карточки данными, а также управляет отображением корзины удаления на основании данных о текущем пользователе. Корзина удаления отображается только если создатель карточки текущий пользователь.
- `render(): HTMLElement` – метод возвращает полностью заполненную карточку с установленными слушателями

id – геттер и возвращает уникальный id карточки

#### Класс CardsContainer

Отвечает за отображение блока с карточками на главной странице. Предоставляет метод `setData(state: ICardsState): void` для добавления карточек в контейнер и сеттер container для полной его обновленной содержимого. В конструктор принимает контейнер, в котором размещаются карточки.

### Слой коммуникации

#### Класс AppApi

Принимает в конструктор экземпляр класса Api и предоставляет методы, реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счёт событий, генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`.\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

_Список всех событий, которые могут генерироваться в системе:_\
_События изменения данных (генерируются классами моделями данных)_

- `user:changed` – изменение данных пользователя
- `cards:changed `– изменение массива карточек
- `card:selected` – изменение открываемой в модальном окне картинки карточки
- `card:previewClear` – необходимость очистки данных выбранной для показа в модальном окне карточки

_События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)_

- `productShow:open` – открытие модального окна с просмотром карточки товара
- `basket:open` – открытие модального окна с корзиной пользователя
- `payment:open` – открытие модального окна с выбором способа оплаты
- `contacts:open` – открытие модального окна для ввода контактных данных пользователя
- `orderSuccess:open` – открытие модального окна c завершением оформления заказа
- `card:select` – выбор карточки для отображения в модальном окне
- `card:add` – карточка(продукт) добавлена в корзину пользователя путем нажатия на кнопку "Купить/В корзину"
- `basket:submit` – оформление заказа, переход к вводу данных об оплате
- `order:input` – изменение данных в форме с выбором способа оплаты
- `contacts:input` – изменение данных в форме с вводом контактных данных пользователя
- `order:submit` – сохранение данных заказа(способ оплаты) в модальном окне
- `contacts:submit` – сохранение контактных данных пользователя в модальном окне
- `remove-product:submit` – событие, генерируемое при нажатии кнопки Удалить в форме с корзиной пользователя
- `order:validation` – событие, сообщающее о необходимости валидации формы с оплатой заказа
- `contacts:validation` – событие, сообщающее о необходимости валидации формы с контактными данными пользователя
- `new-place:validation` – событие, сообщающее о необходимости валидации формы создания новой карточки
